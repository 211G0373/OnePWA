<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ONE - Crear Partida</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body class="login-page ">

    <a class="back-button" href="index.html">
        <svg viewBox="0 0 24 24">
            <polyline points="15 18 9 12 15 6"></polyline>
        </svg>
    </a>

    <div class="floating-card"></div>
    <div class="floating-card"></div>
    <div class="floating-card"></div>
    <div class="floating-card"></div>

    <div class="container match-config-container">
        <h1 class="page-title">Crear Partida</h1>

        <div class="config-group">
            <label for="match-name" class="config-label">Nombre de la partida:</label>
            <input type="text" id="match-name" class="config-input" placeholder="Pelusas" value="Pelusas">
        </div>

        <!--<div class="config-group">
            <label for="player-count" class="config-label">Jugadores:</label>
            <div class="player-counter">
                <button type="button" class="counter-btn minus-btn">−</button>
                <span class="counter-display">3</span>
                <button type="button" class="counter-btn plus-btn">+</button>
            </div>
        </div>-->

        <div class="config-group radio-group">
            <label class="config-label">Tipo de Partida:</label>
            <div class="radio-option">
                <input type="radio" id="public" name="match-type" checked>
                <label for="public">Pública</label>
            </div>
            <div class="radio-option">
                <input type="radio" id="private" name="match-type">
                <label for="private">Privada</label>
            </div>
        </div>

        <div class="config-group radio-group">
            <label class="config-label">Reglas:</label>
            <div class="radio-option">
                <input type="radio" id="standard" name="rules" checked>
                <label for="standard">Standard</label>
            </div>
            <div class="radio-option">
                <input type="radio" id="broken-friendship" name="rules">
                <label for="broken-friendship">Rompe amistades</label>
            </div>
        </div>

        <input type="button" value="Crear" id="create" class="create-match-btn">

    </div>

    <script src="script.js"></script>
    <!-- <script src="sw.js"></script>-->
    <script src="updatetoken.js"></script>

    <!--<script>
        if ('serviceWorker' in navigator) {
            try {
                navigator.serviceWorker.register('/sw.js?v=1');

                //navigator.serviceWorker.ready.then(reg =>
                //    //Avisame cuando se vaya y regrese el internet
                //    //reg.sync.register("tareas")
                //);

                navigator.serviceWorker.addEventListener('message', (event) => {
                    if (event.data.type === 'TOKEN_EXPIRADO') {
                        console.log('Token expirado detectado por SW');
                        let token = event.data.jwt;
                        localStorage.setItem('jwtToken', token);
                        headers = {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        };
                        
                    }
                });
            } catch (error) {
                console.log('Error registrando Service Worker:', error);
            }
        }
    </script>-->


    <script>
        let token = localStorage.getItem('jwtToken');
        if (false) {
            window.location.href = 'login.html';
        }
        else {

            let headers = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            };





            document.getElementById('create').addEventListener('click', async (e) => {
                //e.preventDefault();

                //const submitButton = e.target.querySelector('button[type="submit"]');
                //const originalText = submitButton.textContent;

                try {
                    //submitButton.textContent = 'Iniciando sesión...';
                    //submitButton.disabled = true;

                    const formData = {
                        Name: document.getElementById('match-name').value,
                        Private: document.getElementById('private').checked,
                        NewRules: document.getElementById('broken-friendship').checked
                    };
                    console.log(formData);
                    const response = await fetch('/api/Sessions/', {
                        method: 'POST',
                        headers,
                        body: JSON.stringify(formData)
                    });

                    if (response.ok) {
                        //    const token = await response.text();
                        //    localStorage.setItem('jwtToken', token);
                        window.location.href = 'crearpartida2.html';
                        //} else {
                        //    const emailInput = document.getElementById('email');
                        //    emailInput.setCustomValidity('Credenciales incorrectas');
                        //    emailInput.reportValidity();
                        //}
                    }
                    //} else {

                    //        let response2 = await fetch("/api/users/renew");
                    //        if (response2.ok) {
                    //            newtoken = await response2.text();
                    //            localStorage.setItem('jwtToken', token);
                    //            headers = {
                    //                'Content-Type': 'application/json',
                    //                'Authorization': `Bearer ${newtoken}`
                    //            };
                    //            //window.location.href = 'index.html';
                    //            console.log("reintentar");

                    //            const response3 = await fetch('/api/Sessions/', {
                    //                method: 'POST',
                    //                headers,
                    //                body: JSON.stringify(formData)
                    //            });

                    //            if (response3.ok) {
                    //                console.log("xd");

                    //            }

                    //        }
                    //}
                } catch (error) {
                    //const emailInput = document.getElementById('email');
                    //emailInput.setCustomValidity('Error de conexión');
                    //emailInput.reportValidity();
                } finally {
                    //submitButton.textContent = originalText;
                    //submitButton.disabled = false;
                }
            });

            // Quitar mensaje validación al escribir
            //document.getElementById('email').addEventListener('input', function () {
            //    this.setCustomValidity('');
            //});
            //document.getElementById('password').addEventListener('input', function () {
            //    document.getElementById('email').setCustomValidity('');
            //});
        }
    </script>

</body>
</html>
