<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ONE - PERFIL</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body class="login-page"><!-- profile-page-->
    <a class="back-button" href="index.html">
        <svg viewBox="0 0 24 24">
            <polyline points="15 18 9 12 15 6"></polyline>
        </svg>
    </a>
    <div class="floating-card"></div>
    <div class="floating-card"></div>
    <div class="floating-card"></div>
    <div class="floating-card"></div>

    <div class="profile-card">

        <h1 class="profile-title">Perfil de Usuario</h1>

        <div class="profile-avatar">
            <img src="Assets/profilePic.png" alt="Foto de perfil" class="profile-avatar-img" id="profilePic">
            <button type="button" class="edit-avatar-btn" aria-label="Editar foto de perfil" onclick="openAvatarModal()">
                <img src="Assets/editProfile.svg" alt="">
            </button>
        </div>

        <form class="profile-form" id="profileForm">
            <div class="profile-field">
                <label for="username">Nombre de Usuario</label>
                <input type="text" class="profile-input" placeholder="Nombre" id="username"  required>
            </div>

            <div class="profile-field">
                <label for="password">Contraseña Nueva</label>
                <div class="profile-input-wrapper">
                    <input type="password" class="profile-input"
                           placeholder="Contraseña" id="password"
                           >
                    <button type="button" class="password-toggle" aria-label="Mostrar contraseña">
                        <ion-icon name="eye-outline"></ion-icon>
                    </button>
                </div>
            </div>

            <div class="profile-actions">
                <a href="PerfilUsuario.html" class="login-button profile-primary-btn action-link" id="cambios">Guardar Cambios</a>
                <a href="login.html" class="login-button profile-secondary-btn action-link">Cerrar Sesión</a>
            </div>
        </form>

    </div>

    <div id="avatarModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeAvatarModal()">&times;</span>
            <h2 class="modal-title">Selecciona tu Avatar</h2>
            <div class="avatar-grid">
                <div class="avatar-option" data-avatar="1.jpg">
                    <img src="Assets/avatars/1.jpg" class="profile-avatar-img" alt="Avatar 1">
                </div>
                <div class="avatar-option" data-avatar="2.jpg">
                    <img src="Assets/avatars/2.jpg" class="profile-avatar-img" alt="Avatar 2">
                </div>
                <div class="avatar-option" data-avatar="3.jpg">
                    <img src="Assets/avatars/3.jpg" class="profile-avatar-img" alt="Avatar 3">
                </div>
                <div class="avatar-option" data-avatar="4.jpg">
                    <img src="Assets/avatars/4.jpg" class="profile-avatar-img" alt="Avatar 4">
                </div>
                <div class="avatar-option" data-avatar="5.jpg">
                    <img src="Assets/avatars/5.jpg" class="profile-avatar-img" alt="Avatar 5">
                </div>
                <div class="avatar-option" data-avatar="6.jpg">
                    <img src="Assets/avatars/6.jpg" class="profile-avatar-img" alt="Avatar 6">
                </div>
                <div class="avatar-option" data-avatar="7.jpg">
                    <img src="Assets/avatars/7.jpg" class="profile-avatar-img" alt="Avatar 7">
                </div>
                <div class="avatar-option" data-avatar="8.jpg">
                    <img src="Assets/avatars/8.jpg" class="profile-avatar-img" alt="Avatar 8">
                </div>
                <div class="avatar-option" data-avatar="9.jpg">
                    <img src="Assets/avatars/9.jpg" class="profile-avatar-img" alt="Avatar 9">
                </div>
                <div class="avatar-option" data-avatar="10.jpg">
                    <img src="Assets/avatars/10.jpg" class="profile-avatar-img" alt="Avatar 10">
                </div>
            </div>
        </div>
    </div>
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    <script src="script.js"></script>
        <script>


        const token = localStorage.getItem('jwtToken');


        const headers = {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
        };
        function obtenerDatosDelToken() {
            console.log("d");

            const token = localStorage.getItem('jwtToken');
            console.log(token);
            const payload = token.split('.')[1];
            console.log(payload);


            const decoded = JSON.parse(atob(payload));

            console.log(decoded);
            return decoded;
        }


        let pic = document.getElementById("profilePic");
        let password = document.getElementById("password");
        let user = document.getElementById("username");
        const datos = obtenerDatosDelToken();

        async function cargar() {

            console.log("ID " + datos.nameid);

            const response = await fetch('/api/Users/perfil/' + datos.nameid, {
                method: 'GET',
                headers
            });


            if (response.ok) {
                console.log("FETCH THINGY WORKS");

                const datos = await response.json();
                console.log(datos);
                pic.src = datos.fotoPerfil;
                user.value = datos.nombre;

            }
            else {
                console.log("FETCH DONT WORK");
            }
        }


        cargar();



        let pics = document.getElementsByClassName("avatar-option");

        console.log(pics);

        for (var i = 0; i < pics.length; i++) {

            ( function (index) {
                pics[index].addEventListener("click", async function (e) {
                    console.log("you pic region number " + pics[index].children[0].src);

                    let text = pics[index].children[0].src;
                    let img = text.split("/");
                    let source = img[5];
                    console.log(source);
                    //const response = await fetch('/api/Users/ProfilePic/', {
                    //    method: 'POST',
                    //    headers,
                    //    body: JSON.stringify({
                    //        id: datos.nameid,
                    //        picture: source,
                    //    })
                    //})

                    if (response.ok) {
                        closeAvatarModal()

                        pic.src = "Assets/avatars/" + source;
                       
                        
                    }


                })
            })(i);
        }



        let btn = document.getElementById("cambios").addEventListener("click", async function(e){
            e.preventDefault();
                 console.log("HOLA");

            const response = await fetch('/api/Users/UpdateProfile/', {
                method: 'POST',
                headers,
                body: JSON.stringify({
                    id: datos.nameid,
                    nombre: user.value,
                    contraseña: password.value,
                    fotoPerfil: pic.src
                })


            });

        });




    </script>

</body>
</html>
