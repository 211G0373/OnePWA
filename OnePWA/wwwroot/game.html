<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

    <title>ONE - Game</title>
    <link rel="stylesheet" href="styles.css" />
    <style>
        html{
            overflow-x:hidden;
        }
        .player-slot {
            position: relative;
        }

        .game-page {
            height: 100%;
        }



        .player-hand {
            position: absolute;
            bottom: clamp(10px, 1.5vw, 16px);
            
            left: 50%;
            transform: translateX(-70%);
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: clamp(0px, 0.4vw, 6px);
        }

        .hand-card {
            transform-origin: center bottom;
            filter: drop-shadow(0 8px 14px rgba(0, 0, 0, 0.7));
            position: relative;
            width: clamp(78px, 10vw, 100px);
            max-width:100px;
            height: auto;
            display: inline-block;
            margin-right: -55px;
            cursor: pointer;
            transition: all 0.3s;
        }

            .hand-card:first-child {
                margin-left: 0; /* La primera carta no se desplaza */
            }

            .hand-card:hover {
                transform: translateY(-20px) scale(1.1); /* Efecto cuando pasas el mouse */
                z-index: 100 !important;
            }

            .hand-card img {
                width: clamp(78px, 10vw, 118px);
                max-width:100px;
                height: auto;
            }


      /*  .hand-card-1 {
            transform: translateY(10px) rotate(-28deg);
            z-index: 1;
        }

        .hand-card-2 {
            transform: translateY(6px) rotate(-18deg);
            z-index: 2;
        }

        .hand-card-3 {
            transform: translateY(3px) rotate(-8deg);
            z-index: 3;
        }

        .hand-card-4 {
            transform: translateY(0) rotate(0deg);
            z-index: 4;
        }

        .hand-card-5 {
            transform: translateY(3px) rotate(8deg);
            z-index: 3;
        }

        .hand-card-6 {
            transform: translateY(6px) rotate(18deg);
            z-index: 2;
        }

        .hand-card-7 {
            transform: translateY(10px) rotate(28deg);
            z-index: 1;
        }*/



     /*   .draw-pile {
            grid-row: 1 / 2;
            grid-column: 1 / 2;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

            .draw-pile .card-base {
                width: clamp(68px, 8vw, 90px);
                height: auto;
                filter: drop-shadow(0 12px 18px rgba(0, 0, 0, 0.6));
            }

            .draw-pile:hover .card-base {
                transform: translateY(-10px);
                transition: transform 0.3s ease;
                cursor: pointer;
            }

        .draw-count {
            position: absolute;
            bottom: -9px;
            width: 85%;
            text-align: center;
            background: var(--bright-gray);
            border: 2px solid #ccc;
            color: #111;
            padding: 2px 10px;
            border-radius: 2em;
            font-size: 0.9rem;
            font-weight: 900;
            letter-spacing: 0.06em;
        }*/

       /*
        .current-card {
            background-color: red;
             grid-row: 1 / 2;
  grid-column: 2 / 3;
            display: flex;
        }

            .current-card .card.current {
                   width: clamp(90px, 10.5vw, 130px);
    height: auto;
    filter: drop-shadow(0 14px 26px rgba(0, 0, 0, 0.85));
            }*/

        .table-center {
            /*background:orange;*/
            width: 40%;
            max-width: 300px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            /*display: grid;*/
            /* grid-template-columns: 50% 50%;
            grid-template-rows: auto auto;*/
            gap: 5%;
            justify-items: center;
            align-items: center;
            justify-content: center;
            display: flex;
            /*flex-direction:column;*/
            /* column-gap: clamp(24px, 3vw, 36px);
            row-gap: clamp(16px, 2vw, 24px);*/
        }

        .current, .card-base {
            transform-origin: center bottom;
            position: absolute;
            z-index: 200;
            width: 20%;
            max-width: 100px;
            left: 50%;
            top: 50%;
            transform: translateY(-50%) translateX(-110%);
            filter: drop-shadow(5px 5px 5px rgba(0,0,0,0.4));
        }
        .current {
            transform: translateX(10%) translateY(-50%);
            --rot: 0deg;
            --rot2: 0px;
            animation: cart 1s ease-in forwards;
        }

        .current-card, .c2 {
            background:red;
            width: 50%;

        }
        
        .table-center img{
            top:0;
            left:0;
            position:absolute;
            width:100%;
            
        }
        @keyframes cart {
            from {
                transform: scale(10) rotateX(180deg) rotateZ(180deg) translateX(0px) translateY(var(--rot2));
            }

            to {
                transform: translateX(10%) translateY(-50%) rotate(var(--rot));
            }
        }
        
        .pruebadiv {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
        }

        .side-players-left, .side-players-right, .center-player {
            padding-top: 10dvh;
            width: 33.3333%;
        }

            .side-players-left > :nth-child(2) {
                margin-left: 0%;
            }

            .side-players-right > :nth-child(2) {
                margin-right: 0%;
            }



        .player-slot {
            width:100%;
        }

        .side-players-left, .side-players-right {
            padding-bottom: 100px;
            display: flex;
            flex-direction: column;
            /*background: #00333333;*/

            align-content: space-between;
            justify-content: space-around;
        }

        .arrows {
            position: absolute;
            display: flex;
            width: 100%;
            height: 100%;
            max-width: 500px;
            left: 50%;
            transform:translate(-50%);
            top: 0px;
            opacity: 0.5;
        }

        #clock {
            text-align: center;
            justify-content: center;
            align-self: center;
            color: white;
        }

        #Capa_1 {
            opacity: 1;
            width: 100%;
            max-width: 100dvh;
            margin: 0px;
            padding: 0px;
            animation: girar 30s linear infinite;
            transform-origin: center center;
        }

        .reverse #Capa_1 {
            animation: girar-reverse 35s linear infinite;
        }

        @keyframes girar {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        @keyframes girar-reverse {
            from {
                transform: rotate(360deg) scaleX(-1);
            }

            to {
                transform: rotate(0deg) scaleX(-1);
            }
        }

        .turn-label {
            white-space: pre-line;
            
        }

        .turn-indicator {
            transform: translateX(-50%);
            left: 50%;
            top: 65%;
            position: absolute;
            display: flex;
            flex-direction: column;
            z-index:201;
        }

        .left {
            filter: grayscale();
        }
        .loading-page{
            z-index:2000;
            position: absolute;
            top:0;
            left:0;
            height:100%;
            width: 100dvw;
            transition:all 0.5s linear;
        }

        .hide {
            opacity:0;
            display:none;
        }

    </style>
</head>
<body class="game-page">
    <div class="turn-indicator" aria-hidden="true">
        <span class="turn-label">Turno de Pedro</span>
        <h3  id="clock">5:00</h3>
    </div>
    <div class="loading-page">
        <div class="logo">
            <img src="Assets/oneLogo.png" alt="Logo de ONE" class="logo-image" />
        </div>

        <div class="loading-text">
            Cargando partida<span class="dots" id="dots"></span>
        </div>

        <div class="spinner"></div>


        <!--//<script src="script.js"></script>-->

    </div>

    <img id="currentCard" class="card current" src="Assets/Cards/Number Cards/Red/card0=red.png" alt="Carta roja actual" />
    <img class="card-base" src="Assets/Cards/Wild/card-backwards.png" alt="Mazo para robar" />

    <div id="arrows" class="arrows">
        <?xml version="1.0" encoding="iso-8859-1" ?>
        <svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
             viewBox="0 0 79.536 79.536"
             xml:space="preserve">
<g>
        <path style="fill:currentColor; stroke:white" d="M19.545,25.655l-7.104-4.969c5.631-8.055,14.507-13.129,24.172-14.051V0.008L55.323,10.81
		L36.607,21.611v-6.289C29.774,16.208,23.548,19.928,19.545,25.655z M15.31,42.935h6.299L10.802,24.218L0,42.935h6.628
		c0.922,9.662,5.997,18.537,14.051,24.177l4.963-7.11C19.915,55.993,16.2,49.765,15.31,42.935z M42.938,64.217v-6.292L24.226,68.727
		l18.711,10.802V72.9c9.651-0.927,18.517-5.996,24.15-14.038l-7.094-4.971C55.986,59.613,49.752,63.326,42.938,64.217z
		 M72.908,36.604c-0.933-9.655-6.007-18.52-14.054-24.169l-4.971,7.102c5.727,4.013,9.445,10.245,10.336,17.067h-6.292L68.729,55.32
		l10.807-18.716H72.908z" />
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
</svg>
    </div>



    <div class="pruebadiv">
        <div class="side-players-left">


            <template id="playerTemplate">
                <section class="player-slot" aria-label="Jugador Pedro">
                    <div class="player-count-pill">
                        <img class="mini-card-back" src="Assets/Cards/Wild/card-backwards.png" alt="Cartas" />
                        <span class="player-cards-count">3</span>
                    </div>
                    <div class="player-avatar ">
                        <img id="avatar" src="Assets/avatars/4.jpg" alt="Pedro" />
                    </div>
                    <span class="player-name">Pedro</span>
                    <!--<div class="player-timer">
                        <div class="timer-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="12 6 12 12 16 14"></polyline>
                            </svg>
                        </div>
                        <div class="timer-bar-container">
                            <div class="timer-bar"></div>
                        </div>
                    </div>-->
                </section>
            </template>





        </div>
        <div class="center-player">


            <!--<section class="player-slot" aria-label="Jugador Pedro">
                <div class="player-count-pill">
                    <img class="mini-card-back" src="Assets/Cards/Wild/card-backwards.png" alt="Cartas" />
                    <span class="player-cards-count">3</span>
                </div>
                <div class="player-avatar current-turn">
                    <img src="Assets/avatars/4.jpg" alt="Pedro" />
                </div>
                <span class="player-name">Pedro</span>
                <div class="player-timer">
                    <div class="timer-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polyline points="12 6 12 12 16 14"></polyline>
                        </svg>
                    </div>
                    <div class="timer-bar-container">
                        <div class="timer-bar"></div>
                    </div>
                </div>
            </section>-->

        </div>
        <div class="side-players-right">



        </div>

    </div>

    <!-- HEADER: Logo ONE y botón salir -->
    <header class="game-header">
        <div class="game-logo">
            <img src="Assets/ONELogoText.png" alt="ONE" />
        </div>
    </header>

    <button class="logout-button" type="button" aria-label="Salir de la partida" onclick="openModal()">
        <img src="Assets/svgs&icons/logOut.svg" alt="Salir" />
    </button>

    <!-- MESA PRINCIPAL -->
    <main class="game-table" aria-label="Mesa de juego ONE">
        <!-- Slots de jugadores alrededor de la mesa (máx 8) -->
        <!-- Arriba izquierda -->
        <!--<section class="player-slot slot-top-left" aria-label="Jugador Patricia">
            <div class="player-count-pill">
                <img class="mini-card-back" src="Assets/Cards/card-backwards.png" alt="Cartas" />
                <span class="player-cards-count">5</span>
            </div>
            <div class="player-avatar">
                <img src="Assets/avatars/2.jpg" alt="Patricia" />
            </div>
            <span class="player-name">Patricia</span>
            <div class="player-timer">
                <div class="timer-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <polyline points="12 6 12 12 16 14"></polyline>
                    </svg>
                </div>
                <div class="timer-bar-container">
                    <div class="timer-bar"></div>
                </div>
            </div>

        </section>-->
        <!-- Arriba centro -->
        <!-- Arriba derecha -->
        <!--<section class="player-slot slot-top-right" aria-label="Jugador Pedro">
            <div class="player-count-pill">
                <img class="mini-card-back" src="Assets/Cards/Wild/card-backwards.png" alt="Cartas" />
                <span class="player-cards-count">3</span>
            </div>
            <div class="player-avatar current-turn">
                <img src="Assets/avatars/4.jpg" alt="Pedro" />
            </div>
            <span class="player-name">Pedro</span>
            <div class="player-timer">
                <div class="timer-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <polyline points="12 6 12 12 16 14"></polyline>
                    </svg>
                </div>
                <div class="timer-bar-container">
                    <div class="timer-bar"></div>
                </div>
            </div>
        </section>-->
        <!-- Mitad izquierda -->
        <!--<section class="player-slot slot-middle-left" aria-label="Jugador Teo">
            <div class="player-count-pill">
                <img class="mini-card-back" src="Assets/Cards/Wild/card-backwards.png" alt="Cartas" />
                <span class="player-cards-count">3</span>
            </div>
            <div class="player-avatar">
                <img src="Assets/avatars/1.jpg" alt="Teo" />
            </div>
            <span class="player-name">Teo</span>
            <div class="player-timer">
                <div class="timer-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <polyline points="12 6 12 12 16 14"></polyline>
                    </svg>
                </div>
                <div class="timer-bar-container">
                    <div class="timer-bar"></div>
                </div>
            </div>
        </section>-->
        <!-- Mitad derecha -->
        <!--<section class="player-slot slot-middle-right" aria-label="Jugador Lali">
            <div class="player-count-pill">
                <img class="mini-card-back" src="Assets/Cards/Wild/card-backwards.png" alt="Cartas" />
                <span class="player-cards-count">4</span>
            </div>
            <div class="player-avatar">
                <img src="Assets/avatars/5.jpg" alt="Lali" />
            </div>
            <span class="player-name">Lali</span>
            <div class="player-timer">
                <div class="timer-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <polyline points="12 6 12 12 16 14"></polyline>
                    </svg>
                </div>
                <div class="timer-bar-container">
                    <div class="timer-bar"></div>
                </div>
            </div>
        </section>-->
        <!-- Abajo izquierda -->
        <!--<section class="player-slot slot-bottom-left" aria-label="Jugador Ikerto">
            <div class="player-count-pill">
                <img class="mini-card-back" src="Assets/Cards/Wild/card-backwards.png" alt="Cartas" />
                <span class="player-cards-count">9</span>
            </div>
            <div class="player-avatar">
                <img src="Assets/avatars/6.jpg" alt="Ikerto" />
            </div>
            <span class="player-name">Ikerto</span>

            <div class="player-timer">
                <div class="timer-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <polyline points="12 6 12 12 16 14"></polyline>
                    </svg>
                </div>
                <div class="timer-bar-container">
                    <div class="timer-bar"></div>
                </div>
            </div>
        </section>-->
        <!-- Abajo derecha -->
        <!--<section class="player-slot slot-bottom-right" aria-label="Jugador Veta">
            <div class="player-count-pill">
                <img class="mini-card-back" src="Assets/Cards/Wild/card-backwards.png" alt="Cartas" />
                <span class="player-cards-count">6</span>
            </div>
            <div class="player-avatar">
                <img src="Assets/avatars/7.jpg" alt="Veta" />
            </div>
            <span class="player-name">Veta</span>

            <div class="player-timer">
                <div class="timer-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <polyline points="12 6 12 12 16 14"></polyline>
                    </svg>
                </div>
                <div class="timer-bar-container">
                    <div class="timer-bar"></div>
                </div>
            </div>
        </section>-->
        <!-- Zona central con mazo, descartes y carta actual -->
        <section class="table-center" aria-label="Zona central de cartas">
            <!-- Mazo para robar -->
            <div class="c2">

            </div>

            <div class="current-card">

            </div>

            <!-- Indicador de turno central -->




        </section>



        <!-- Mano del jugador principal -->
        <section class="player-hand" aria-label="Tus cartas">
            <template id="handCardTemplate">
                <div class="hand-card">
                    <img src="Assets/Cards/Number Cards/Yellow/card0=yellow.png" alt="Carta amarilla" />
                </div>
            </template>

        </section>
    </main>

    <!-- Botón ONE para cuando quede una carta -->
    <!--<button class="one-button" type="button">
        <span class="one-icon">
            <img src="Assets/svgs&icons/oneHand.svg" alt="ONE" />
        </span>
        <span class="one-text">¡ONE!</span>
    </button>-->
    <!-- Botones temporales para probar modal (eliminar después) -->
    <!--<div style="position: fixed; top: 100px; left: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 9999;">
        <button onclick="testEndgameModal('win')" style="padding: 10px 16px; background: #4D40E3; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
            Ver Ganar
        </button>
        <button onclick="testEndgameModal('lose')" style="padding: 10px 16px; background: #ED2428; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
            Ver Perder
        </button>
    </div>-->
    <!-- Modal Overlay -->

    <div class="modal-overlay" id="logoutModal" onclick="closeModalOnOverlay(event)">
        <div class="generic-modal">
            <button class="close-button" onclick="closeModal()">
                <svg viewBox="0 0 24 24">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>

            <div class="generic-modal-content">
                <h2>¿Está seguro de abandonar el juego?</h2>
                <p class="modal-description">No podrá volver a esta partida</p>

                <div class="modal-buttons">
                    <button class="btn btn-cancel" onclick="closeModal()">
                        Cancelar
                    </button>
                    <button class="btn btn-confirm">
                        Sí
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Botón para probar modal de comodín -->
    <!--<button class="color-picker-trigger" type="button" onclick="openColorPickerModal()">
        Elegir color
    </button>-->
    <!-- Modal selección de color para comodín -->
    <div class="modal-overlay" id="colorPickerModal" aria-hidden="true">
        <div class="generic-modal color-picker-card">
            <button class="close-button color-picker-close" type="button" aria-label="Cerrar selección" onclick="closeColorPickerModal()">
                <svg viewBox="0 0 24 24">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>

            <div class="color-picker-header">
                <h2>Elige un color</h2>
                <p class="modal-description">Selecciona el color para tu comodín</p>
            </div>

            <div class="color-options">
                <button class="color-option color-red" data-color="red" aria-label="Rojo">
                    <span>Rojo</span>
                </button>
                <button class="color-option color-blue" data-color="blue" aria-label="Azul">
                    <span>Azul</span>
                </button>
                <button class="color-option color-green" data-color="green" aria-label="Verde">
                    <span>Verde</span>
                </button>
                <button class="color-option color-yellow" data-color="yellow" aria-label="Amarillo">
                    <span>Amarillo</span>
                </button>
            </div>

        </div>
    </div>

    <!-- Modal de resultado de partida endgame-overlay -->
    <div class="modal-overlay " id="endgameModal" aria-hidden="true">
        <div class="generic-modal endgame-card">
            <button class="close-button endgame-close" type="button" aria-label="Cerrar resultado" onclick="closeEndgameModal()">
                <svg viewBox="0 0 24 24">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>

            <div class="endgame-header">
                <h2 class="endgame-title" id="endgameTitle">¡Ganaste!</h2>
                <div class="endgame-hero">
                    <div class="endgame-hero-avatar">
                        <img id="endgameHeroAvatar" src="Assets/avatars/4.jpg" alt="Avatar del jugador destacado" />
                        <!--<span class="endgame-hero-badge" id="endgameBadge">★</span>-->
                        <img src="Assets/svgs&icons/trophy.png" class="endgame-hero-badge" id="endgameBadge" />
                    </div>
                    <p class="endgame-hero-name" id="endgameHeroName">Pato</p>
                    <p class="endgame-hero-place" id="endgameHeroPlace">1º lugar</p>
                </div>
            </div>


            <div class="endgame-standings" id="endgameStandings">
                <template id="player-end-template">
                    <div class="endgame-row">
                        <div class="endgame-row-left">
                            <span class="endgame-position">1</span>
                            <img class="endgame-row-avatar" src="Assets/avatars/4.jpg" alt="Pato" />
                            <span class="endgame-row-name">Pato</span>
                        </div>
                        <span class="endgame-row-cards">Sin cartas</span>
                    </div>
                </template>
            </div>





            <div class="endgame-actions profile-actions">
                <button type="button" class="login-button profile-secondary-btn">Salir</button>
                <button type="button" class="login-button profile-primary-btn">Jugar de Nuevo</button>
            </div>
        </div>
    </div>

    <script src="script.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
    <script src="updatetoken.js"></script>


    <script>
        const token = localStorage.getItem('jwtToken');




        if (!token) {
            window.location.href = 'login.html';
        }
        else {
            let Session;
            const headers = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            };


            let serverRemainingMs = 0;
            let serverTimestamp = 0;
            let timerInterval = null;

            let specialcard;




            function obtenerDatosDelToken() {

                console.log("d");

                const token = localStorage.getItem('jwtToken');
                console.log(token);
                const payload = token.split('.')[1];
                console.log(payload);


                const decoded = JSON.parse(atob(payload));

                console.log(decoded);
                return decoded;
            }


            const datos = obtenerDatosDelToken();



            document.querySelector(".color-options").addEventListener("click", async function (e) {
                const response = await fetch('/api/sessions/blackcard/',
                    {
                        method: 'POST',
                        headers,
                        body: JSON.stringify({
                            idcard: specialcard.parentElement.dataset.id,
                            color: e.target.dataset.color
                        })
                    });
                if (response.ok) {
                    //  currentCard.src = "/assets/cards/" + specialcard.parentElement.dataset.id + ".png";
                    specialcard.parentElement.remove()
                    closeColorPickerModal();

                }
            });



            function startLocalTimer() {
                timerInterval = setInterval(() => {
                    const elapsed = Date.now() - serverTimestamp;
                    const remaining = Math.max(0, serverRemainingMs - elapsed);

                    updateUI(remaining);

                    if (remaining === 0) {
                        clearInterval(timerInterval);
                        timerInterval = null;
                    }
                }, 200); // 200ms = fluido y ligero
            }


            function updateUI(ms) {
                const totalSeconds = Math.ceil(ms / 1000);
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = totalSeconds % 60;

                document.getElementById("clock").textContent =
                    `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }





            const histotial = document.querySelector("#historial");
            const turnode = document.querySelector("#turnode");
            const currentCard = document.getElementById("currentCard");

            const turnlabel = document.querySelector(".turn-label");

            const handCardTemplate = document.getElementById("handCardTemplate");

            const playersDiv = document.querySelector(".players");


            //const template = document.querySelector("template");
            const myCards = document.querySelector(".player-hand");

            const playerTemplate = document.getElementById("playerTemplate");
            const leftPlayers = document.querySelector(".side-players-left");
            const rightPlayers = document.querySelector(".side-players-right");
            const centerPlayer = document.querySelector(".center-player");
            const arrows = document.querySelector("#arrows");
            const svg = document.querySelector("#Capa_1");
            const endGameButtons = document.querySelector(".endgame-actions");


            endGameButtons.addEventListener("click", async function (e) {
                if (e.target.classList.contains("profile-primary-btn")) {
                    const response = await fetch('/api/Sessions/Replay/', {
                        method: 'POST',
                        headers

                    });
                    if (response.ok) {
                        window.location.href = "crearpartida2.html";
                    }
                }
            });

            document.querySelector(".btn-confirm").addEventListener("click", async function () {
                const response = await fetch('/api/Sessions/leave/', {
                    method: 'POST',
                    headers

                });
                if (response.ok) {
                    window.location.href = "index.html";
                }




            });


            myCards.addEventListener("click", async function (e) {
                if (e.target.tagName === "IMG") {


                    if (e.target.parentElement.dataset.color != "black") {

                        console.log("Carta jugada:", e.target.parentElement.dataset.id);
                        const response = await fetch('/api/Sessions/PlayCard/' + e.target.parentElement.dataset.id, {
                            method: 'POST',
                            headers

                        });
                        if (response.ok) {
                            //currentCard.src = "/Assets/Cards/" + e.target.parentElement.dataset.id + ".png";
                            e.target.parentElement.remove()

                        }
                    }
                    else {
                        specialcard = e.target;
                        openColorPickerModal();


                        console.log("Carta especial jugada:", e.target.parentElement.dataset.id);
                        // const color = prompt("Elige un color: red, blue, green, yellow");


                    }





                }
            });


            async function cargar() {
                const response = await fetch('/api/Sessions/Playing', {
                    method: 'GET',
                    headers

                });
                if (response.ok) {
                    Session = await response.json();


                    console.log('Sesión creada:', Session);

                    serverRemainingMs = Session.time;
                    serverTimestamp = Date.now();

                    if (!timerInterval) {
                        startLocalTimer();
                    }



                    //let indice = 0;

                    let sideleftplayers;
                    let centerplayer = 0;

                    if (Session.playerCount % 2 == 0) {
                        centerplayer = 1;
                    }

                    sideleftplayers = Math.floor((Session.playerCount - 1 - centerplayer) / 2);

                    let indice = Session.players.findIndex(x => x.id == datos.nameid);
                    let plrys = [];


                    for (let i = indice; i < Session.players.length; i++) {
                        plrys.push(Session.players[i]);
                    };
                    for (let i = 0; i < indice; i++) {
                        plrys.push(Session.players[i]);
                    };

                    svg.style.color = Session.lastColor;

                    if (Session.reverse) {
                        if (!arrows.classList.contains("reverse")) {
                            arrows.classList.add("reverse");
                        }
                    } else {
                        arrows.classList.remove("reverse");
                    }

                    let indiceJugadorRecorrido = 1;

                    for (let i = indiceJugadorRecorrido; i < (indiceJugadorRecorrido + sideleftplayers); i++) {
                        const card = playerTemplate.content.firstElementChild.cloneNode(true);
                        card.querySelector("#avatar").src = "Assets/avatars/" + plrys[i].fotoPerfil;
                        card.querySelector(".player-cards-count").textContent = plrys[i].cardsCount;
                        card.dataset.id = plrys[i].id;



                        card.querySelector(".player-name").textContent = plrys[i].userName;





                        leftPlayers.appendChild(card);

                    }
                    indiceJugadorRecorrido += sideleftplayers;
                    for (let i = indiceJugadorRecorrido; i < indiceJugadorRecorrido + centerplayer; i++) {
                        const card = playerTemplate.content.firstElementChild.cloneNode(true);
                        //const card = clon.querySelector("div");
                        //card.textContent = Session.myCards[j].color + " " + Session.myCards[j].name;
                        card.querySelector(".player-name").textContent = plrys[i].userName;

                        card.querySelector("#avatar").src = "Assets/avatars/" + plrys[i].fotoPerfil;
                        card.querySelector(".player-cards-count").textContent = plrys[i].cardsCount;
                        card.dataset.id = plrys[i].id;







                        console.log("ss");
                        console.log(card);
                        centerPlayer.appendChild(card);
                    }
                    indiceJugadorRecorrido += centerplayer;

                    for (let i = indiceJugadorRecorrido; i < indiceJugadorRecorrido + sideleftplayers; i++) {
                        const card = playerTemplate.content.firstElementChild.cloneNode(true);
                        //const card = clon.querySelector("div");
                        //card.textContent = Session.myCards[j].color + " " + Session.myCards[j].name;
                        card.querySelector(".player-name").textContent = plrys[i].userName;
                        card.querySelector("#avatar").src = "Assets/avatars/" + plrys[i].fotoPerfil;

                        card.querySelector(".player-cards-count").textContent = plrys[i].cardsCount;
                        card.dataset.id = plrys[i].id;







                        console.log("ss");
                        console.log(card);
                        rightPlayers.appendChild(card);
                    }


                    //console.log(players);

                    //if (Session.players[i].id != datos.nameid) {
                    //    players[i].querySelector(".player-name").textContent = Session.players[i].userName;
                    //    players[i].style.display = "block";
                    //}
                    //    //let clone = template.content.cloneNode(true);
                    //    //console.log("sdsds");
                    //    //// clone.dataset.id = "j";
                    //    //clone.querySelector(".name").textContent = Session.players[i].userName;
                    //    //clone.querySelector(".cardsCount").textContent = Session.players[i].cardsCount;
                    //    //playersDiv.appendChild(clone);
                    console.log("XDDDD")

                    if (Session.idTurn == datos.nameid) {
                        turnlabel.textContent = "Es tu turno";
                    } else {
                        turnlabel.textContent = "Turno de " + Session.players.find(u => u.id === Session.idTurn).userName;

                    }



                    console.log("XDDDD")




                    for (let j = 0; j < Session.myCards.length; j++) {
                        console.log("XDDDD")
                        const card = handCardTemplate.content.firstElementChild.cloneNode(true);
                        //  = clon.querySelector("div");
                        //card.textContent = Session.myCards[j].color + " " + Session.myCards[j].name;
                        card.dataset.id = Session.myCards[j].id;
                        card.dataset.color = Session.myCards[j].color;
                        card.dataset.name = Session.myCards[j].name;

                        card.firstElementChild.src = "/Assets/Cards/" + Session.myCards[j].id + ".png";


                        console.log("ss");
                        console.log(card);
                        myCards.appendChild(card);
                    };
                    if (Session.idTurn != datos.nameid) {
                        document.querySelector('[data-id="' + Session.idTurn + '"]').querySelector(".player-avatar").classList.add("current-turn");

                    }

                    currentCard.src = "/Assets/Cards/" + Session.lastCard.id + ".png";

                }
                else {
                    window.location.href = 'index.html';

                }

                document.querySelector(".loading-page").classList.add("hide");


            }

            cargar();





            const connection = new signalR.HubConnectionBuilder()
                .withUrl("/hubs/Signalr?access_token=" + token)
                .configureLogging(signalR.LogLevel.Information)
                .build();

            connection.start()
                .then(() => {
                    console.log("✅ Conectado correctamente al servidor SignalR");
                    //  document.body.innerHTML += "<p>✅ Conexión establecida</p>";
                })
                .catch(err => {
                    console.error("❌ Error de conexión:", err);
                    document.body.innerHTML += "<p>❌ Error de conexión: " + err + "</p>";
                });

            connection.on("PlayerLeft", (carta) => {
                turnlabel.textContent = Session.players.find(u => u.id === carta.idPlayer).userName + " Abandono la partida";


                if (carta.idPlayer != datos.nameid) {
                    const el = document.querySelector('[data-id="' + carta.idPlayer + '"]');
                    el.classList.add("left");
                    document.querySelector('[data-id="' + carta.idPlayer + '"]').querySelector(".player-avatar").classList.remove("current-turn");

                    //checar despues
                    Session.players = Session.players.filter(s => s.id != carta.idPlayer);


                }


                try {
                    let turn = Session.players.find(u => u.id === carta.idTurn);
                    if (turn.id == datos.nameid) {
                        turnlabel.textContent += "\nEs tu turno"
                    }
                    else {
                        turnlabel.textContent += "\nEs turno de " + Session.players.find(u => u.id === carta.idTurn).userName;
                        //current-turn
                        document.querySelector('[data-id="' + carta.idPlayer + '"]').querySelector(".player-avatar").classList.remove("current-turn");
                    }

                    serverRemainingMs = carta.time;
                    serverTimestamp = Date.now();

                    if (!timerInterval) {
                        startLocalTimer();
                    }
                } catch { };




            });


            connection.on("PlayerTakeCard", (carta) => {
                console.log("jugador tomo carta:", carta);
                //budvst el contador de cartas del jugador

                
                let p = Session.players.find(u => u.id === carta.idPlayer);
                p.cardsCount++;
                document.querySelector('[data-id="' + carta.idPlayer + '"]').querySelector(".player-cards-count").textContent = p.cardsCount;
                turnlabel.textContent = p.userName + " tomo una carta";


                try {
                    let turn = Session.players.find(u => u.id === carta.idTurn);
                    if (turn.id == datos.nameid) {
                        turnlabel.textContent += "\nEs tu turno"
                    }
                    else {
                        turnlabel.textContent += "\nEs turno de " + Session.players.find(u => u.id === carta.idTurn).userName;
                    }


                    serverRemainingMs = carta.time;
                    serverTimestamp = Date.now();

                    if (!timerInterval) {
                        startLocalTimer();
                    }

                } catch { };


            });
            connection.on("YouTakeCard", (carta) => {
                console.log("tomaste la carta:", carta);




                let p = Session.players.find(u => u.id == datos.nameid);
                p.cardsCount++;

                const clon = handCardTemplate.content.cloneNode(true);
                const card = clon.querySelector("div");
                //card.textContent = Session.myCards[j].color + " " + Session.myCards[j].name;
                card.dataset.id = carta.card.id;
                card.dataset.color = carta.card.color;
                card.dataset.name = carta.card.name;


                // currentCard.src = "/Assets/Cards/" + carta.card.id + ".png";
                //datos.nameid

                turnlabel.textContent = "Tomaste una carta";

                try {
                    let turn = Session.players.find(u => u.id === carta.idTurn);
                    if (turn.id == datos.nameid) {
                        turnlabel.textContent += "\nEs tu turno"
                    }
                    else {
                        turnlabel.textContent += "\nEs turno de " + Session.players.find(u => u.id === carta.idTurn).userName;
                    }


                    serverRemainingMs = carta.time;
                    serverTimestamp = Date.now();

                    if (!timerInterval) {
                        startLocalTimer();
                    }





                } catch { };



                //console.log("ss");
                //console.log(card);
                card.replaceChildren();
                myCards.appendChild(card);
                let elemento = document.querySelector(".card-base").cloneNode();
                elemento.src = "/Assets/Cards/" + carta.card.id + ".png";

                document.querySelector("body").appendChild(elemento);

                moverConAnimacion(elemento, card, 700);


            });

            async function dats(carta) {
                const newcard = document.createElement("img");
                const rot = (Math.random() * 20 - 10).toFixed(2); // -10° a +10°

                console.log(rot);
                newcard.style.setProperty('--rot', `${rot}deg`);

                newcard.src = "/Assets/Cards/Wild/card-backwards.png";
                document.querySelector("body").appendChild(newcard);
                newcard.classList.add("current");
                await new Promise(r => setTimeout(r, 500));
                newcard.src = "/Assets/Cards/" + carta.card.id + ".png";
            }


            function moverConAnimacion(elemento, nuevoContenedor, duracion = 500) {
                // Guardar transform original


                const transformOriginal = elemento.style.transform || "";


                // FIRST
                const first = elemento.getBoundingClientRect();

                // Mover en el DOM
                nuevoContenedor.appendChild(elemento);

                // LAST
                const last = elemento.getBoundingClientRect();

                // Diferencia
                const dx = first.left - last.left;
                const dy = first.top - last.top;

                // Invertir SIN romper el transform existente
                elemento.style.transition = "none";
                elemento.style.transform = `translate(${dx}px, ${dy}px) ${transformOriginal}`;

                // Play
                requestAnimationFrame(() => {
                    elemento.style.transition = `all ${duracion}ms ease`;
                    elemento.style.transform = transformOriginal || "translate(0, 0)";
                });
                elemento.classList.remove("card-base");


                console.log("movido");
            }


            connection.on("PlayerPlaceCard", async (carta) => {

                console.log("Carta jugada por otro jugador:", carta.card.id);

                const newcard = document.createElement("img");
                const rot = (Math.random() * 20 - 10).toFixed(2); // -10° a +10°

                console.log(rot);
                if (carta.idPlayer == datos.nameid) {
                    newcard.style.setProperty('--rot2', `200px`);
                } else {
                    newcard.style.setProperty('--rot2', `-100px`);
                }


                newcard.style.setProperty('--rot', `${rot}deg`);

                newcard.src = "/Assets/Cards/Wild/card-backwards.png";
                document.querySelector("body").appendChild(newcard);
                newcard.classList.add("current");
                await new Promise(r => setTimeout(r, 500));
                newcard.src = "/Assets/Cards/" + carta.card.id + ".png";



                //currentCard.src =
                svg.style.color = carta.card.color;


                let p = Session.players.find(u => u.id === carta.idPlayer);
                p.cardsCount--;




                if (carta.idPlayer != datos.nameid) {
                    document.querySelector('[data-id="' + carta.idPlayer + '"]').querySelector(".player-cards-count").textContent = p.cardsCount;
                    turnlabel.textContent = p.userName + " coloco una carta";

                } else {
                    turnlabel.textContent = "Colocaste una carta";

                }

                try {
                    let turn = Session.players.find(u => u.id === carta.idTurn);
                    if (turn.id == datos.nameid) {



                        turnlabel.textContent += "\nEs tu turno"
                    }
                    else {



                        turnlabel.textContent += "\nEs turno de " + Session.players.find(u => u.id === carta.idTurn).userName;
                    }

                    serverRemainingMs = carta.time;
                    serverTimestamp = Date.now();

                    if (!timerInterval) {
                        startLocalTimer();
                    }


                } catch { };








                if (carta.reverse) {
                    if (!arrows.classList.contains("reverse")) {
                        arrows.classList.add("reverse");
                    }
                } else {
                    arrows.classList.remove("reverse");
                }



            });

            connection.on("GameFinished", (ganador) => {


                const Winner = document.querySelector(".endgame-header");
                const PlayerList = document.querySelector("#player-end-template");

                if (ganador.ganador == datos.nameid) {
                    openEndgameModal('win');

                    //mensaje

                    //la copa

                } else {
                    openEndgameModal('lose');
                    //mensaje
                    Winner.querySelector(".endgame-title").textContent = "Perdiste...";
                    Winner.querySelector(".endgame-hero-place").textContent = "";
                    //la copa
                }

                Winner.querySelector("img").src = "Assets/avatars/" + Session.players.find(x => x.id == datos.nameid).fotoPerfil;
                Winner.querySelector(".endgame-hero-name").textContent = Session.players.find(x => x.id == datos.nameid).userName;

                Session.players.sort((a, b) => {
                    if (a.cardsCount !== b.cardsCount)
                        return a.cardsCount - b.cardsCount;

                    return a.userName.localeCompare(b.userName);
                });

                for (let i = 0; i < Session.players.length; i++) {
                    const p = PlayerList.content.firstElementChild.cloneNode(true);
                    p.querySelector(".endgame-position").textContent = i + 1;
                    p.querySelector("img").src = "Assets/avatars/" + Session.players[i].fotoPerfil;
                    p.querySelector(".endgame-row-name").textContent = Session.players[i].userName;

                    if (i == 0) {
                        p.querySelector(".endgame-row-cards").textContent = "Sin cartas";
                    } else {
                        const c = Session.players[i].cardsCount;

                        p.querySelector(".endgame-row-cards").textContent =
                            `${c} carta${c !== 1 ? "s" : ""}`;


                    }
                    document.querySelector(".endgame-standings").appendChild(p);

                }





            });

            connection.on("Close", () => {
                window.location.href = 'index.html';

            });




        }

    </script>

</body>
</html>

