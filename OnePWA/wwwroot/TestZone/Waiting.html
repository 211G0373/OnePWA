<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title></title>
</head>
<body>
    <h1>Esperando</h1>

    
    <h2>Host</h2>
    <label id="host">El jefe es</label>
    <label id="code"></label>

    <ul id="playerlist">
        <li>Jugador 1</li>
    </ul>


    <div id="qrcode"></div>



    <button id="start">start</button>
    <button id="leave">abandonar</button>


    <script src="https://cdn.jsdelivr.net/gh/davidshimjs/qrcodejs/qrcode.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
    <script>
        const token = localStorage.getItem('jwtToken');
        console.log(token);
        //QRCode.prototype.makeImage = true;

        if (!token) {
            window.location.href = 'login.html';
        }
        else {
            let Session;
            const headers = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            };



            document.getElementById("start").addEventListener("click", async function () {
                console.log("xd")
                const response = await fetch('/api/Sessions/Start', {
                    method: 'POST',
                    headers

                });
                if (response.ok) {
                    window.location.href = 'game.html';
                }
                else {
                    console.log("Error al iniciar la partida");
                }

            });



            //const connection = new signalR.HubConnectionBuilder()
            //    .withUrl("https://localhost:44355/hubs/Signalr", {
            //        accessTokenFactory: () => token
            //    })
            //    .configureLogging(signalR.LogLevel.Information)
            //    .build();

            //const response = await fetch('/api/Sessions/', {
            //    method: 'POST',
            //    headers,
            //    body: JSON.stringify(formData)
            //});
            async function cargar() {
                const response = await fetch('/api/Sessions', {
                    method: 'GET',
                    headers

                });
                if (response.ok) {
                    Session = await response.json();


                    console.log('Sesión creada:', Session);



                    for (let i = 0; i < Session.players.length; i++) {
                        const li = document.createElement("li");
                        li.textContent = Session.players[i].userName;
                        document.getElementById("playerlist").appendChild(li);
                    };
                    document.getElementById("host").textContent = "El jefe es " + Session.players.find(u => u.id === Session.idHost).userName;
                    document.getElementById("code").textContent = Session.code;
                    new QRCode(document.getElementById("qrcode"), {
                        text: Session.code,
                        width: 128,
                        height: 128,
                        colorDark: "#000000",
                        colorLight: "#ffffff",
                        correctLevel: QRCode.CorrectLevel.H
                    });






                    // window.location.href = 'index.html';
                }
                else {
                    window.location.href = 'index.html';

                }




            }

            cargar();



            const connection = new signalR.HubConnectionBuilder()
                .withUrl("https://differentsagetrail38.conveyor.cloud/hubs/Signalr?access_token=" + token)
                .configureLogging(signalR.LogLevel.Information)
                .build();

            connection.start()
                .then(() => {
                    console.log("✅ Conectado correctamente al servidor SignalR");
                    //  document.body.innerHTML += "<p>✅ Conexión establecida</p>";
                })
                .catch(err => {
                    console.error("❌ Error de conexión:", err);
                    document.body.innerHTML += "<p>❌ Error de conexión: " + err + "</p>";
                });


            connection.on("GameStarted", () => {
                console.log("start")
                window.location.href = 'game.html';
            });

            connection.on("PlayerJoined", (player) => {
                console.log(player);
                Session.players.push(player);
                const li = document.createElement("li");
                li.textContent = player.userName;
                document.getElementById("playerlist").appendChild(li);
            });
            connection.on("PlayerLeft", (player) => {
                console.log(player);
            });
        }

    </script>


</body>
</html>